<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev.to Analytics - <%= @org %></title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max_width: 1200px;
            margin: 0 auto;
        }
        header {
            margin-bottom: 30px;
            text-align: center;
        }
        h1 {
            color: #2c3e50;
        }
        .subtitle {
            color: #7f8c8d;
        }
        .cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 150px;
        }
        .card h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #7f8c8d;
        }
        .card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .charts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        @media (min-width: 768px) {
            .charts {
                grid-template-columns: 1fr 1fr;
            }
            .full-width {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dev.to Analytics Dashboard</h1>
            <div class="subtitle">Organization: <strong><%= @org %></strong> | Date: <strong><%= @date %></strong></div>
        </header>

        <% 
           total_views = @data.sum { |r| r['totals'] && r['totals']['page_views'] ? r['totals']['page_views']['total'] : 0 }
           total_reactions = @data.sum { |r| r['totals'] && r['totals']['reactions'] ? (r['totals']['reactions']['total'] || r['totals']['reactions']['like']) : 0 }
           total_comments = @data.sum { |r| r['totals'] && r['totals']['comments'] ? r['totals']['comments']['total'] : 0 }
        %>

        <div class="cards">
            <div class="card">
                <h3>Total Views</h3>
                <div class="value"><%= total_views %></div>
            </div>
            <div class="card">
                <h3>Total Reactions</h3>
                <div class="value"><%= total_reactions %></div>
            </div>
            <div class="card">
                <h3>Total Comments</h3>
                <div class="value"><%= total_comments %></div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container full-width">
                <canvas id="viewsChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="engagementChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="scatterChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const rawData = <%= @data.to_json %>;
        
        // Process data
        const articles = rawData.map(item => {
            const totals = item.totals || {};
            const views = totals.page_views ? totals.page_views.total : 0;
            const reactions = totals.reactions ? (totals.reactions.total || totals.reactions.like) : 0;
            const comments = totals.comments ? totals.comments.total : 0;
            
            return {
                title: item.article.title,
                views: views,
                reactions: reactions,
                comments: comments
            };
        });

        // Sort by views for the main chart
        const topArticles = [...articles].sort((a, b) => b.views - a.views).slice(0, 10);

        // Views Chart
        new Chart(document.getElementById('viewsChart'), {
            type: 'bar',
            data: {
                labels: topArticles.map(a => a.title.substring(0, 30) + '...'),
                datasets: [{
                    label: 'Page Views',
                    data: topArticles.map(a => a.views),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top 10 Articles by Views'
                    }
                }
            }
        });

        // Engagement Chart
        new Chart(document.getElementById('engagementChart'), {
            type: 'bar',
            data: {
                labels: topArticles.map(a => a.title.substring(0, 20) + '...'),
                datasets: [
                    {
                        label: 'Reactions',
                        data: topArticles.map(a => a.reactions),
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    },
                    {
                        label: 'Comments',
                        data: topArticles.map(a => a.comments),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Engagement (Reactions vs Comments)'
                    }
                }
            }
        });

        // Scatter Chart (Views vs Reactions)
        new Chart(document.getElementById('scatterChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Views vs Reactions',
                    data: articles.map(a => ({x: a.views, y: a.reactions})),
                    backgroundColor: 'rgba(153, 102, 255, 0.6)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Correlation: Views vs Reactions'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Views'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Reactions'
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
